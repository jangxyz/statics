<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>최근 내 상태 좋아한 사람</title>

    <script src="base.js"></script>
    <link rel="stylesheet" type="text/css" href="fb-likes.css" />

    <script src="lodash.min.js"></script>
    <script src="underscore.string.min.js"></script>
    <script src="coffee-script.js"></script>
    <script src="jquery-1.10.2.min.js"></script>
    <script src="moment.min.js"></script>

    <script type="text/javascript" src="http://neomparam.github.io/feeduck/feeduck.jquery.js"></script>
    <link rel="stylesheet" href="http://neomparam.github.io/feeduck/feeduck.css" type="text/css" />

    <script src="status-log.js"></script>
    <link rel="stylesheet" type="text/css" href="status-log.css" />

</head>
<body>
<div id="fb-root"></div>

<h1>최근 내 상태 좋아한 사람</h1>
<p>
    주의: 당신의 데이터는 아무렇게나 쓰일 수 있습니다.
</p>

<div class='checking-login-status'>
    로그인 확인 중...
</div>
<ul class="actions">
    <li class='login auth-action'>
        페이스북에 <a href="" class='login'>로그인</a>하세여
    </li>
    <li class='logout auth-action'>
        페이스북에서 <a href="#" onclick="logoutFacebook();return false;">로그아웃</a>
    </li>
</ul>

<div id='result'>
</div>

<script type="text/coffeescript">
    #
    # Get count of people who liked my posts
    #
    window.show = getMyLikersCount = ->
        $el = $("#result")

        limit = 50

        query = 
            query1: """
                SELECT post_id 
                FROM stream 
                WHERE source_id = me() AND actor_id = me() 
                    AND type != 80
                    AND privacy.value != "SELF" 
                    AND message != ""
                LIMIT #{limit}
            """
            query2: """
                SELECT post_id,user_id FROM like WHERE post_id in (
                    SELECT post_id FROM #query1
                )
            """
            query3: """
                SELECT uid,name FROM user WHERE uid in (
                    SELECT user_id FROM #query2
                )
            """
            query4: """
                SELECT post_id,message,created_time,permalink FROM stream WHERE post_id in (
                    SELECT post_id FROM #query2
                )
            """

        runQuery query, (response) -> 
            _status.log("query fetched")
            console.log("Fetched after query", response)
            #window.response = response            

            #
            [result0,result1,result2,result3] = (r.fql_result_set for r in response[0..3])
            $el.text(" (#{result0.length})" )
            _status.log("among #{result0.length} posts ..")
            _status.log("#{result1.length} liked activities..")
            #
            user_map = {}
            (user_map[r.uid] = r for r in result2)
            _status.log("#{result2.length} users liked..")
            #
            post_map = {}
            (post_map[r.post_id] = r for r in result3)
            _status.log("#{result3.length} posts..")
            #
            userlike_map = {}
            (userlike_map[r.user_id] = []            for r in result1)
            (userlike_map[r.user_id].push(r.post_id) for r in result1)
            userlike_list = []
            (userlike_list.push([user_id, post_ids]) for user_id, post_ids of userlike_map)
            userlike_list = _.sortBy(userlike_list, ([user_id, post_ids]) -> -post_ids.length)
            ga('send', 'event', 'my-likers', 'post-count', "#{result0.length}/#{limit}")
            ga('send', 'event', 'my-likers', 'most-like-count', userlike_list[0][1].length)

            #
            $table = $('<table class="result-data"></table>')
            for userlike in userlike_list
                [user_id,post_ids] = userlike[0..1]
                user_name  = user_map[user_id].name
                post_count = post_ids.length
                posts      = (post_map[post_id] for post_id in post_ids)
                
                $("<tr class='count'></tr>")
                    .append("""
                        <td>#{user_name}</td>
                        <td>#{post_count}</td>
                    """).on('click', (e) ->
                        $(this).nextUntil('tr.count').filter('tr.post-message')
                            .toggleClass('folded')
                    )
                .appendTo($table)
                for post in posts
                    post_link = "<a href='#{post.permalink}'>#{post.message}</a>"
                    $("<tr class='post-message folded'></tr>")
                        .append("""
                            <td colspan="2">#{post_link}</td>
                        """)
                    .appendTo($table)
            $table.appendTo($el)


        _status.log("<pre class='fql'>#{JSON.stringify query}</pre>")
        #$el.append("<pre class='fql'>#{JSON.stringify query}</pre>")

</script>

<script type="text/javascript">
    function startApp() {
        $('.checking-login-status').hide();
        $('#actions li.login').hide();
        //
        show();
    }
</script>

<ul id="status" style="display: none;"></ul>
</body>
</html>
