<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>최근 내가 like한 친구 - 상대적</title>

    <script src="base.js"></script>
    <link rel="stylesheet" type="text/css" href="fb-likes.css" />

    <script src="lodash.min.js"></script>
    <script src="underscore.string.min.js"></script>
    <script src="coffee-script.js"></script>
    <script src="jquery-1.10.2.min.js"></script>
    <script src="moment.min.js"></script>

    <script type="text/javascript" src="http://neomparam.github.io/feeduck/feeduck.jquery.js"></script>
    <link rel="stylesheet" href="http://neomparam.github.io/feeduck/feeduck.css" type="text/css" />

    <script src="status-log.js"></script>
    <link rel="stylesheet" type="text/css" href="status-log.css" />


</head>
<body>
<div id="fb-root"></div>

<h1>최근 내가 like한 친구 - 상대적</h1>
<p>
    주의: 당신의 데이터는 아무렇게나 쓰일 수 있습니다.
</p>

<div class='checking-login-status'>
    로그인 확인 중...
</div>
<ul class="actions">
    <li class='login auth-action'>
        페이스북에 <a href="" class='login'>로그인</a>하세여
    </li>
    <li class='logout auth-action'>
        페이스북에서 <a href="#" onclick="logoutFacebook();return false;">로그아웃</a>
    </li>
</ul>

<div id='result'>
</div>

<script type="text/coffeescript">
    #
    # Get friends whose posts I liked
    #
    window.show = getLikedFriendsCount = ->
        $el = $("#result")

        limit = 1000

        query = 
            # friends
            query1: """
                SELECT uid2 FROM friend WHERE uid1 = me()
            """
            # friends' posts
            query2: """
                SELECT source_id, post_id, message, created_time, permalink, like_info
                    FROM stream
                    WHERE source_id IN (SELECT uid2 FROM #query1) 
                    LIMIT #{limit}
            """
            # user info
            query3: """
                SELECT uid,name 
                    FROM user 
                    WHERE uid in (SELECT uid2 FROM #query1)
            """

        runQuery query, (response) -> 
            _status.log("query fetched")
            console.log("Fetched after query", response)

            #
            [friend_ids,friend_posts,user_info] = (r.fql_result_set for r in response[0..2])
            liked_posts = (r for r in friend_posts when r.like_info.user_likes is true)
            #
            $el.text(" (#{friend_ids.length})" )
            _status.log("among #{friend_ids.length} friends ..")
            _status.log("#{liked_posts.length} liked posts..")
            #
            user_map = {}
            (user_map[r.uid] = r for r in user_info)
            #
            post_map = {}
            (post_map[r.post_id] = r for r in friend_posts)
            _status.log("#{friend_posts.length} posts..")
            #
            liked_posts_map = {}
            (liked_posts_map[r.source_id] = []            for r in liked_posts)
            (liked_posts_map[r.source_id].push(r.post_id) for r in liked_posts)
            liked_posts_list = []
            (liked_posts_list.push([user_id, post_ids]) for user_id, post_ids of liked_posts_map)
            liked_posts_list = _.sortBy(liked_posts_list, ([user_id, post_ids]) -> -post_ids.length)
            #
            friend_posts_count_map = {}
            (friend_posts_count_map[r.source_id]  = 0 for r in friend_posts)
            (friend_posts_count_map[r.source_id] += 1 for r in friend_posts)
            #
            ga('send', 'event', 'my-likes-friend', 'post-count', "#{friend_ids.length}/#{limit}")
            if liked_posts_list
                ga('send', 'event', 'my-likes-friend', 'most-like-count', liked_posts_list[0][1].length)

            #
            $table = $('<table class="result-data"></table>')
            for liked_posts in liked_posts_list
                [user_id,post_ids] = liked_posts[0..1]
                user_name        = user_map[user_id].name
                liked_post_count = post_ids.length
                total_post_count = friend_posts_count_map[user_id]
                posts      = (post_map[post_id] for post_id in post_ids)
                posts      = posts || [];
                
                $("<tr class='count'></tr>")
                    .append("""
                        <td>#{user_name}</td>
                        <td>#{liked_post_count/total_post_count}</td>
                        <td>#{liked_post_count}</td>
                        <td>#{total_post_count}</td>
                    """).on('click', (e) ->
                        $(this).nextUntil('tr.count').filter('tr.post-message')
                            .toggleClass('folded')
                    )
                .appendTo($table)
                for post in posts
                    if not post?
                        console.log('cannot find post for :', liked_posts)
                        continue
                    post_link = "<a href='#{post.permalink}'>#{post.message}</a>"
                    $("<tr class='post-message folded'></tr>")
                        .append("""
                            <td colspan="2">#{post_link}</td>
                        """)
                    .appendTo($table)
            $table.appendTo($el)


        _status.log("<pre class='fql'>#{JSON.stringify query}</pre>")
        #$el.append("<pre class='fql'>#{JSON.stringify query}</pre>")


</script>

<script type="text/javascript">
    function startApp() {
        $('.checking-login-status').hide();
        $('#actions li.login').hide();
        //
        show();
    }
</script>

<ul id="status" style="display: none;"></ul>
</body>
</html>


