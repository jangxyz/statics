<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>최근 내가 like한 포스팅</title>

    <script src="base.js"></script>
    <link rel="stylesheet" type="text/css" href="fb-likes.css" />

    <script src="lodash.min.js"></script>
    <script src="underscore.string.min.js"></script>
    <script src="coffee-script.js"></script>
    <script src="jquery-1.10.2.min.js"></script>
    <script src="moment.min.js"></script>

    <script type="text/javascript" src="http://neomparam.github.io/feeduck/feeduck.jquery.js"></script>
    <link rel="stylesheet" href="http://neomparam.github.io/feeduck/feeduck.css" type="text/css" />

    <script src="status-log.js"></script>
    <link rel="stylesheet" type="text/css" href="status-log.css" />


</head>
<body>
<div id="fb-root"></div>

<h1>최근 내가 like한 포스팅</h1>
<p>
    주의: 당신의 데이터는 아무렇게나 쓰일 수 있습니다.
</p>

<div class='checking-login-status'>
    로그인 확인 중...
</div>
<ul class="actions">
    <li class='login auth-action'>
        페이스북에 <a href="" class='login'>로그인</a>하세여
    </li>
    <li class='logout auth-action'>
        페이스북에서 <a href="#" onclick="logoutFacebook();return false;">로그아웃</a>
    </li>
</ul>

<div id='result'>
</div>

<script type="text/coffeescript">
    #
    # Get posts which I liked
    #
    window.show = getPostsILiked = ->
        $el = $("#result")

        limit = 1000
        query = """
                    SELECT post_id, source_id, message, like_info.like_count, permalink, created_time
                        FROM stream 
                        WHERE source_id IN (
                                SELECT target_id FROM connection WHERE source_id=me() and is_following=1
                            ) 
                            AND likes.user_likes=1 
                        LIMIT #{limit}
                """

        runQuery query, (response) -> 
            _status.log("query fetched");
            console.log("Fetched after query", response);
            
            ga('send', 'event', 'my-likes-post', 'result', "#{response.length}/#{limit}")

            #
            $table = $('<table class="result-data"></table>')
            for r in response
                date = moment(r.created_time * 1000).format('MM/DD HH:mm');
                $("<tr class='post' id='post-#{r.post_id}'></tr>")
                    .append("""
                        <td class="post_id">#{r.post_id}</td>
                        <td class="message"><a href="#{r.permalink}" target="_blank">#{r.message}</a></td>
                        <td class="like_count">#{r.like_info.like_count}</td>
                        <td class="created_time"><a href="#{r.permalink}" target="_blank">#{date}</a></td>
                    """)
                .appendTo($table)
            $table.appendTo($el)

        _status.log("<pre class='fql'>#{JSON.stringify query}</pre>")
        #$el.append("<pre class='fql'>#{JSON.stringify query}</pre>")


</script>

<script type="text/javascript">
    function startApp() {
        $('.checking-login-status').hide();
        $('#actions li.login').hide();
        //
        show();
    }
</script>

<ul id="status" style="display: none;"></ul>
</body>
</html>


